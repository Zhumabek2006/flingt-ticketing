<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Панель Менеджера Компании v4</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f5f5f5;
      }
      .header {
        background: #28a745;
        color: white;
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .container {
        max-width: 1200px;
        margin: 20px auto;
        padding: 0 20px;
      }
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }
      .stat-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        text-align: center;
      }
      .stat-number {
        font-size: 2em;
        font-weight: bold;
        color: #28a745;
      }
      .section {
        background: white;
        margin: 20px 0;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .form-group {
        margin: 15px 0;
      }
      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      .form-group input,
      .form-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
      }
      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }
      .btn {
        background: #28a745;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      .btn:hover {
        background: #218838;
      }
      .btn-danger {
        background: #dc3545;
      }
      .btn-danger:hover {
        background: #c82333;
      }
      .btn-info {
        background: #17a2b8;
      }
      .btn-info:hover {
        background: #138496;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
      }
      th,
      td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }
      th {
        background-color: #f8f9fa;
        font-weight: bold;
      }
      .status-active {
        color: #28a745;
        font-weight: bold;
      }
      .status-inactive {
        color: #dc3545;
        font-weight: bold;
      }
      .status-refunded {
        color: #fd7e14;
        font-weight: bold;
      }
      .hidden {
        display: none;
      }
      .logout-btn {
        background: #dc3545;
        color: white;
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      .filters {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
        align-items: end;
      }
      /* Toasts */
      .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        z-index: 9999;
      }
      .toast {
        min-width: 260px;
        max-width: 360px;
        background: #fff;
        border-left: 6px solid #28a745;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        border-radius: 8px;
        padding: 12px 14px;
        display: flex;
        gap: 10px;
        animation: slideIn 0.35s ease, fadeOut 0.3s ease 4.2s forwards;
      }
      .toast.error {
        border-left-color: #dc3545;
      }
      .toast .title {
        font-weight: 700;
        margin-bottom: 4px;
      }
      .toast .msg {
        color: #444;
      }
      @keyframes slideIn {
        from {
          transform: translateY(-10px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }
      @keyframes fadeOut {
        to {
          opacity: 0;
          transform: translateY(-6px);
        }
      }
      .btn {
        transition: transform 0.08s ease, box-shadow 0.2s ease;
      }
      .btn:active {
        transform: translateY(1px);
      }
    </style>
  </head>
  <body>
    <div class="toast-container" id="toastContainer"></div>
    <div class="header">
      <h1>Панель Менеджера Компании</h1>
      <div>
        <span
          id="managerName"
          style="margin-right: 10px; font-weight: bold"
        ></span>
        <span id="managerEmail"></span>
        <button class="logout-btn" onclick="logout()">Выйти</button>
      </div>
    </div>

    <div class="container">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="totalFlights">-</div>
          <div>Всего рейсов</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="activeFlights">-</div>
          <div>Активных рейсов</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="totalSeats">-</div>
          <div>Всего мест</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="totalRevenue">-</div>
          <div>Общий доход (руб.)</div>
        </div>
      </div>

      <div class="section">
        <h2>Добавить новый рейс</h2>
        <form id="flightForm">
          <div class="form-row">
            <div class="form-group">
              <label for="flightNumber">Номер рейса:</label>
              <input type="text" id="flightNumber" required />
            </div>
            <div class="form-group">
              <label for="price">Цена билета (руб.):</label>
              <input type="number" id="price" min="0" step="0.01" required />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="departureCity">Откуда:</label>
              <input type="text" id="departureCity" required />
            </div>
            <div class="form-group">
              <label for="arrivalCity">Куда:</label>
              <input type="text" id="arrivalCity" required />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="departureDate">Дата вылета:</label>
              <input type="date" id="departureDate" required />
            </div>
            <div class="form-group">
              <label for="departureTime">Время вылета:</label>
              <input type="time" id="departureTime" required />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="arrivalDate">Дата прилета:</label>
              <input type="date" id="arrivalDate" required />
            </div>
            <div class="form-group">
              <label for="arrivalTime">Время прилета:</label>
              <input type="time" id="arrivalTime" required />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="totalSeatsInput">Количество мест:</label>
              <input type="number" id="totalSeatsInput" min="1" required />
            </div>
          </div>
          <button type="submit" class="btn">Добавить рейс</button>
        </form>
      </div>

      <div class="section">
        <h2>Управление рейсами</h2>
        <div class="filters" id="filtersSection">
          <div class="form-group">
            <label for="filterCity">Фильтр по городу:</label>
            <input type="text" id="filterCity" placeholder="Введите город" />
          </div>
          <div class="form-group">
            <label for="filterDate">Фильтр по дате:</label>
            <input type="date" id="filterDate" />
          </div>
          <div class="form-group">
            <label for="filterStatus">Статус:</label>
            <select id="filterStatus">
              <option value="">Все</option>
              <option value="active">Активные</option>
              <option value="inactive">Неактивные</option>
            </select>
          </div>
          <div class="form-group">
            <button class="btn" onclick="applyFilters()">Искать</button>
            <button class="btn btn-danger" onclick="clearFilters()">
              Очистить
            </button>
          </div>
        </div>

        <div id="flightsTable">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Номер рейса</th>
                <th>Маршрут</th>
                <th>Дата/Время</th>
                <th>Места</th>
                <th>Цена</th>
                <th>Статус</th>
                <th>Действия</th>
              </tr>
            </thead>
            <tbody id="flightsTableBody"></tbody>
          </table>
        </div>
        <div class="section hidden" id="passengersSection">
          <h3>Пассажиры рейса <span id="passengersFlightId"></span></h3>
          <table>
            <thead>
              <tr>
                <th>ID Билета</th>
                <th>Пассажир</th>
                <th>Email</th>
                <th>Статус билета</th>
                <th>Цена</th>
                <th>Дата покупки</th>
              </tr>
            </thead>
            <tbody id="passengersTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      let currentUser = null;
      let allFlights = [];

      // Проверка авторизации при загрузке
      window.onload = async () => {
        const token = localStorage.getItem("token");
        if (!token) {
          window.location.href = "login.html";
          return;
        }

        try {
          const response = await fetch("http://localhost:8000/users/me", {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (response.ok) {
            currentUser = await response.json();
            if (currentUser.role !== "manager") {
              alert("Доступ запрещен. Требуются права менеджера.");
              window.location.href = "index.html";
              return;
            }
            const fullName = [currentUser.first_name, currentUser.last_name]
              .filter(Boolean)
              .join(" ");
            document.getElementById("managerName").textContent =
              fullName || "Менеджер";
            document.getElementById(
              "managerEmail"
            ).textContent = `(${currentUser.email})`;

            // Установить минимальную дату для полей ввода
            const today = new Date().toISOString().split("T")[0];
            document.getElementById("departureDate").min = today;
            document.getElementById("arrivalDate").min = today;

            loadStats();
            refreshFlights(); // Загружаем рейсы при входе
          } else {
            window.location.href = "login.html";
          }
        } catch (error) {
          console.error("Ошибка:", error);
          window.location.href = "login.html";
        }
      };

      // Загрузка статистики
      async function loadStats() {
        try {
          const response = await fetch("http://localhost:8000/company/stats", {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });
          const stats = await response.json();
          document.getElementById("totalFlights").textContent =
            stats.total_flights;
          document.getElementById("activeFlights").textContent =
            stats.active_flights;
          document.getElementById("totalSeats").textContent = stats.total_seats;
          document.getElementById("totalRevenue").textContent =
            stats.total_revenue.toFixed(2);
        } catch (error) {
          console.error("Ошибка загрузки статистики:", error);
        }
      }

      // Добавление рейса
      document
        .getElementById("flightForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const flightData = {
            flight_number: document.getElementById("flightNumber").value.trim(),
            departure_city: document
              .getElementById("departureCity")
              .value.trim(),
            arrival_city: document.getElementById("arrivalCity").value.trim(),
            departure_date: document.getElementById("departureDate").value,
            departure_time: document.getElementById("departureTime").value,
            arrival_date: document.getElementById("arrivalDate").value,
            arrival_time: document.getElementById("arrivalTime").value,
            total_seats: parseInt(
              document.getElementById("totalSeatsInput").value
            ),
            price: parseFloat(document.getElementById("price").value),
          };

          try {
            const response = await fetch(
              "http://localhost:8000/company/flights",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${localStorage.getItem("token")}`,
                },
                body: JSON.stringify(flightData),
              }
            );

            if (response.ok) {
              toast("Успешно", "Рейс добавлен", "success");
              document.getElementById("flightForm").reset();
              loadStats();
              refreshFlights(); // Автоматически обновляем список рейсов
            } else {
              const error = await response.json();
              toast(
                "Ошибка",
                error.detail || "Не удалось добавить рейс",
                "error"
              );
            }
          } catch (error) {
            toast("Ошибка", error.message, "error");
          }
        });

      // Загрузка и обновление списка рейсов
      async function refreshFlights() {
        try {
          const response = await fetch(
            "http://localhost:8000/company/flights",
            {
              headers: {
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
            }
          );
          allFlights = await response.json();
          applyFilters(); // Отображаем рейсы с учетом текущих фильтров
        } catch (error) {
          console.error("Ошибка загрузки рейсов:", error);
        }
      }

      // Отображение рейсов
      function displayFlights(flights) {
        const tableBody = document.getElementById("flightsTableBody");
        tableBody.innerHTML = "";

        if (flights.length === 0) {
          tableBody.innerHTML = `<tr><td colspan="8" style="text-align: center; color: #666;">По вашему запросу ничего не найдено</td></tr>`;
          return;
        }

        flights.forEach((flight) => {
          const row = document.createElement("tr");
          row.innerHTML = `
                    <td>${flight.id}</td>
                    <td>${flight.flight_number}</td>
                    <td>${flight.departure_city} → ${flight.arrival_city}</td>
                    <td>${flight.departure_date} ${flight.departure_time}</td>
                    <td>${flight.available_seats}/${flight.total_seats}</td>
                    <td>${flight.price} руб.</td>
                    <td class="${
                      flight.is_active ? "status-active" : "status-inactive"
                    }">
                        ${flight.is_active ? "Активен" : "Неактивен"}
                    </td>
                    <td>
                        <button class="btn ${
                          flight.is_active ? "btn-danger" : "btn"
                        }" 
                                onclick="toggleFlightStatus(${flight.id}, ${
            flight.is_active
          })">
                            ${
                              flight.is_active
                                ? "Деактивировать"
                                : "Активировать"
                            }
                        </button>
                        <button class="btn btn-info" onclick="viewPassengers(${
                          flight.id
                        })">Пассажиры</button>
                        <button class="btn btn-danger" onclick="deleteFlight(${
                          flight.id
                        })">Удалить</button>
                    </td>
                `;
          tableBody.appendChild(row);
        });
      }

      // Переключение статуса рейса
      async function toggleFlightStatus(flightId, currentStatus) {
        try {
          const response = await fetch(
            `http://localhost:8000/company/flights/${flightId}/status`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
              body: JSON.stringify({ is_active: !currentStatus }),
            }
          );

          if (response.ok) {
            toast(
              "Готово",
              `Рейс ${!currentStatus ? "активирован" : "деактивирован"}`,
              "success"
            );
            loadStats();
            refreshFlights(); // Автоматически обновляем список
          } else {
            const error = await response.json();
            toast(
              "Ошибка",
              error.detail || "Не удалось изменить статус",
              "error"
            );
          }
        } catch (error) {
          toast("Ошибка", error.message, "error");
        }
      }

      // Перевод статуса билета на русский
      function translateTicketStatus(status) {
        switch (status) {
          case "active":
            return '<span class="status-active">Активен</span>';
          case "refunded":
            return '<span class="status-refunded">Возврат</span>';
          case "canceled":
            return '<span class="status-inactive">Отменен</span>';
          default:
            return status;
        }
      }

      // Просмотр пассажиров рейса
      async function viewPassengers(flightId) {
        try {
          const response = await fetch(
            `http://localhost:8000/company/flights/${flightId}/passengers`,
            {
              headers: {
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
            }
          );
          if (!response.ok) {
            const err = await response.json();
            toast(
              "Ошибка",
              err.detail || "Не удалось загрузить пассажиров",
              "error"
            );
            return;
          }
          const passengers = await response.json();
          const tbody = document.getElementById("passengersTableBody");
          tbody.innerHTML = "";
          passengers.forEach((p) => {
            const row = document.createElement("tr");
            const name =
              [p.user.first_name, p.user.last_name].filter(Boolean).join(" ") ||
              "—";
            row.innerHTML = `
                        <td>${p.ticket_id}</td>
                        <td>${name}</td>
                        <td>${p.user.email}</td>
                        <td>${translateTicketStatus(p.status)}</td>
                        <td>${p.price}</td>
                        <td>${new Date(p.created_at).toLocaleString(
                          "ru-RU"
                        )}</td>
                    `;
            tbody.appendChild(row);
          });
          document.getElementById(
            "passengersFlightId"
          ).textContent = `#${flightId}`;
          const section = document.getElementById("passengersSection");
          section.classList.remove("hidden");
          section.scrollIntoView({ behavior: "smooth" }); // Плавный скролл к списку
        } catch (e) {
          console.error(e);
          toast("Ошибка", "Не удалось загрузить пассажиров", "error");
        }
      }

      // Удаление рейса
      async function deleteFlight(flightId) {
        if (
          !confirm(
            "Вы уверены, что хотите удалить этот рейс? Это действие необратимо."
          )
        )
          return;
        try {
          const response = await fetch(
            `http://localhost:8000/company/flights/${flightId}`,
            {
              method: "DELETE",
              headers: {
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
            }
          );
          if (!response.ok) {
            const err = await response.json();
            toast(
              "Ошибка",
              "Не удалось удалить рейс: " + (err.detail || "ошибка"),
              "error"
            );
            return;
          }
          toast("Готово", "Рейс удалён", "success");
          loadStats();
          refreshFlights(); // Автоматически обновляем список
        } catch (e) {
          console.error(e);
          toast("Ошибка", "Ошибка при удалении рейса", "error");
        }
      }

      // Toast helper
      function toast(title, message, type = "success") {
        const container = document.getElementById("toastContainer");
        const el = document.createElement("div");
        el.className = "toast" + (type === "error" ? " error" : "");
        el.innerHTML = `<div><div class="title">${title}</div><div class="msg">${message}</div></div>`;
        container.appendChild(el);
        setTimeout(() => {
          el.remove();
        }, 4600);
      }

      // Применение фильтров
      function applyFilters() {
        const cityFilter = document
          .getElementById("filterCity")
          .value.toLowerCase();
        const dateFilter = document.getElementById("filterDate").value;
        const statusFilter = document.getElementById("filterStatus").value;
        let filteredFlights = allFlights;
        if (cityFilter) {
          filteredFlights = filteredFlights.filter(
            (flight) =>
              flight.departure_city.toLowerCase().includes(cityFilter) ||
              flight.arrival_city.toLowerCase().includes(cityFilter)
          );
        }
        if (dateFilter) {
          filteredFlights = filteredFlights.filter(
            (flight) => flight.departure_date === dateFilter
          );
        }
        if (statusFilter) {
          const isActive = statusFilter === "active";
          filteredFlights = filteredFlights.filter(
            (flight) => flight.is_active === isActive
          );
        }
        displayFlights(filteredFlights);
      }

      // Очистка фильтров
      function clearFilters() {
        document.getElementById("filterCity").value = "";
        document.getElementById("filterDate").value = "";
        document.getElementById("filterStatus").value = "";
        displayFlights(allFlights);
      }

      // Выход
      function logout() {
        localStorage.removeItem("token");
        window.location.href = "index.html";
      }
    </script>
  </body>
</html>
